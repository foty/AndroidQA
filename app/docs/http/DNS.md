### DNS

DNS，即域名系统(DomainNameSystem)，就是进行域名解析的服务器。DNS是因特网的一项核心服务,它作为可以将域名和IP地址
相互映射的一个分布式数据库。

#### 域名空间结构

域名的空间结构是一个树形结构。最顶部的称之为[根]，根下一级的叫顶级域名，如com、net、cn等等；再往下的叫二级域名，后面
的依次是三级域名、四级域名。这是它的空间结构。输入在浏览器的域名也是分顶级域名，二级域名的。只是域名的空间结构越顶端
就越拍在后面。比如`www.baidu.com`。com是顶级域名，baidu是二级域名，www是三级域名。

#### DNS服务器结构

有4类：
* 根域名服务器
  > 储存负责每个域(如.com，.cn等)的解析的域名服务器的地址信息。(全球只有13台根域名服务器)
* 顶级域名服务器
  > 解析顶级域名
* 权威域名服务器
  > 保存域名与ip的映射列表，可以根据域名找到最终的ip，返回ip地址给请求服务器
* 本地DNS服务器
  > 本地dns服务器没有寻址能力，它只能缓存DNS域名与ip地址的映射(一般来说，本地DNS服务器都在运营商那里)


#### DNS工作流程

客户端(浏览器)发起一个网络请求时，首先就是要经过DNS服务，将域名转化为IP地址，然后通过IP地址建立连接。DNS的解析过程为：

* 本地DNS缓存解析
  > 找本地缓存ip映射，找本地host文件；如果未找到就请求本地DNS服务器解析；
* 本地DNS服务器解析
  > 本地服务器DNS查找域名缓存，如果未找到则发请求给根域名服务器；
* 根域名服务器解析
  > 根域名服务器查询后，如果没有则返回请求对应的顶级域名服务器地址，本地dns服务器请求顶级域名服务器地址；
* 顶级域名服务器
  > 顶级域名服务器查询后，如果没有则返回请求对应的权威域名服务器地址，本地dns服务器请求权威域名服务器地址；
* 权威域名服务器
  > 权威域名服务器查询后，找到请求对应的ip地址，返回给本地DNS服务器；本地DNS服务器将IP返回给客户端，客户端缓存
  > 该ip地址。


#### DNS缺陷

* 不稳定
  > 遭遇DNS劫持，DNS污染，DNS服务器宕机等
* 不准确 
* 不及时

#### DNS劫持与DNS污染

DNS劫持：
> 拦截域名解析的请求，分析请求的域名，返回假的ip地址或者使请求失去响应。简单来说就是篡改DNS服务器上的数据返回用户错误的查询结果。

DNS污染：
> 当用户发起域名解析请求时，某个服务器(非DNS)监控到用户访问的已经被标记的地址时，该服务器伪装成DNS服务器向用户发回错误的地址;

区别：
> DNS劫持修改了dns解析的结果；DNS污染是不经过DNS服务器，直接返回了错误的地址。

#### DNS优化

* ip直连(会导致多域名ip直连问题 --使用SNI技术处理)
  > 即直接使用ip地址访问网络，不使用域名，从而绕过DNS解析。但存在问题：ip地址非固定；Https还需要证书；很多服务器下有很多子服务器，他们的ip对外可能是一样的；

* HttpDNS
  > 面向移动开发者推出的一款域名解析产品，对比传统DNS具有域名防劫持、精准调度等特性。


区别：
> IP直连的本质做法是绕过DNS，从根本上上解决问题。
> 而Https另辟蹊径：既然udp不可靠，那么就换成可靠的tcp，既然运营商Local-DNS容易被劫持，那就不用运营商的，用自己的服务器。


#### HttpDNS特点

特点 | HttpDNS  | 传统DNS
:---: | :--- | :---
防劫持 |	Http基于Tcp，具有一定防劫持功能，传输可靠  |  大部分基于Udp，容易被黑客篡改，防劫持能力差
调度算法 |  根据来源ip，就近、就快的接入业务节点   |  不同运营商有不同的接入策略，调度策略无统一标准
快速生效 |  避免Local DNS不遵循权威TTL，解析结果长时间无法更新  | 会自行修改DNS的TTL(Time-To-Live，DNS缓存时间)，导致DNS的修改，延迟生效
解析延迟 |  快(预解析机制，将热点域名提前解析，网络连接时直接缓存获取)  |  多重服务器查询，解析时长慢

#### 实际应用(OKHttp)

可以自己开发，也可以使用现成的，比如腾讯云、阿里云等。

#### OkHttp接入HttpDNS
步骤：
* 实现DNS接口，重写lookup()方法，解析域名时，去DNS缓存中查找，如果找不到走系统默认解析。
* 调用OkHttp的dns()方法，替换OkHttp的域名解析实现



<https://blog.csdn.net/jdsjlzx/article/details/123761340>